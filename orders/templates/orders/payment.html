{% extends 'orders/header.html' %}
{% load static %}

{% block content %}
<head>
  <meta charset="UTF-8">
  <title>Payment Page</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
  <div class="container">
    <h2 style="text-align: center; margin-bottom: 20px;">Order Summary</h2>
    <ul style="list-style-type: none; padding: 0;">
      {% for item in cart_items %}
        <li style="margin: 10px 0; font-size: 18px;">
          {{ item.qty }} x {{ item.item_description }} — ₹{{ item.price|floatformat:2 }}
        </li>
      {% endfor %}
    </ul>

    <p class="total" style="font-weight: bold; font-size: 20px; margin-top: 20px;">Total: ₹{{ total_amount|floatformat:2 }}</p>

    
    <form action="{% url 'orders:stripe_checkout' %}" method="POST">
      {% csrf_token %}
      <button type="submit" class="btn btn-primary">Pay with Stripe</button>
  </form>

<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe("{{ STRIPE_PUBLISHABLE_KEY }}");
  const elements = stripe.elements();
  const card = elements.create("card");
  card.mount("#card-element");

  const form = document.getElementById("payment-form");
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const { error, paymentIntent } = await stripe.confirmCardPayment(
      "{{ client_secret }}",
      {
        payment_method: {
          card: card,
        }
      }
    );

    if (error) {
      alert(error.message);
    } else if (paymentIntent && paymentIntent.status === 'succeeded') {
      window.location.href = "{% url 'orders:payment_success' %}";
    }
  });
</script>

  </div>
</body>
{% endblock %}
